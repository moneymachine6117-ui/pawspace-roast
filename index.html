<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>PawSpace ‚Äì Roast Your Pet</title>

<style>
  body {
    margin: 0;
    background: #0b0b0f;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    color: white;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
  }

  .container {
    width: 360px;
    text-align: center;
  }

  h2 { margin-bottom: 12px; }

  input[type="file"] {
    color: white;
    margin-bottom: 6px;
  }

  .disclaimer {
    font-size: 12px;
    opacity: 0.6;
    margin-bottom: 14px;
  }

  .card {
    display: none;
    background: linear-gradient(180deg, #12121a, #0b0b0f);
    border-radius: 28px;
    overflow: hidden;
    box-shadow: 0 30px 60px rgba(0,0,0,0.6);
  }

  .image-wrap {
    width: 100%;
    aspect-ratio: 1 / 1;
    background: #1a1a24;
  }

  .image-wrap img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .content {
    padding: 20px;
  }

  .roast {
    font-size: 22px;
    font-weight: 800;
    line-height: 1.25;
    margin-bottom: 12px;
    opacity: 1;
    transition: opacity 0.6s ease;
  }

  .footer {
    font-size: 11px;
    opacity: 0.75;
    letter-spacing: 0.4px;
  }

  .footer .cta { font-weight: 700; }

  button {
    width: 100%;
    padding: 12px;
    margin-top: 12px;
    border-radius: 14px;
    border: none;
    font-weight: 700;
    cursor: pointer;
  }

  .primary {
    background: white;
    color: black;
  }

  .secondary {
    background: transparent;
    border: 1px solid #333;
    color: #aaa;
  }
</style>
</head>

<body>
<div class="container">

  <h2>Upload your pet üêæ</h2>

  <input type="file" accept="image/*" id="upload" />
  <div class="disclaimer">
    Upload only pet images. Inappropriate content may be removed.
  </div>

  <div class="card" id="card">
    <div class="image-wrap">
      <img id="petImage" crossorigin="anonymous" />
    </div>
    <div class="content">
      <div class="roast" id="roastText"></div>
      <div class="footer">
        PAWSPACE ¬∑ Roast your pet ‚Üí
        <span class="cta">pawspace.vercel.app</span>
      </div>
    </div>
  </div>

  <button class="primary" id="generateBtn">Generate Roast</button>
  <button class="primary" id="shareBtn" style="display:none;">Share Image</button>
  <button class="primary" id="videoBtn" style="display:none;">Create Share Video</button>
  <button class="secondary" id="downloadBtn" style="display:none;">Download Image</button>

</div>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<script>
  const upload = document.getElementById("upload");
  const petImage = document.getElementById("petImage");
  const card = document.getElementById("card");
  const roastText = document.getElementById("roastText");
  const generateBtn = document.getElementById("generateBtn");
  const downloadBtn = document.getElementById("downloadBtn");
  const shareBtn = document.getElementById("shareBtn");
  const videoBtn = document.getElementById("videoBtn");

  let imageLoaded = false;

  const fallbackRoasts = [
    "Zero thoughts. Unlimited confidence.",
    "Acts surprised by consequences it caused.",
    "Main character energy. Side character intelligence.",
    "Runs entirely on delusion.",
    "A menace with no strategy."
  ];

  upload.addEventListener("change", () => {
    const file = upload.files[0];
    if (!file) return;
    petImage.onload = () => imageLoaded = true;
    petImage.src = URL.createObjectURL(file);
  });

  async function getRoast() {
    try {
      const res = await fetch("/api/roast", { method: "POST" });
      const data = await res.json();
      return data.roast;
    } catch {
      return fallbackRoasts[Math.floor(Math.random() * fallbackRoasts.length)];
    }
  }

  generateBtn.addEventListener("click", async () => {
    if (!imageLoaded) {
      alert("Upload a pet image first üê∂");
      return;
    }

    upload.style.display = "none";
    generateBtn.style.display = "none";

    roastText.textContent = "Roasting...";
    card.style.display = "block";

    const roast = await getRoast();
    roastText.textContent = roast;

    shareBtn.style.display = "block";
    downloadBtn.style.display = "block";
    videoBtn.style.display = "block";
  });

  async function generateCanvas() {
    await new Promise(r => setTimeout(r, 400));
    const rect = card.getBoundingClientRect();
    return html2canvas(card, {
      backgroundColor: "#0b0b0f",
      scale: 4,
      width: rect.width,
      height: rect.height,
      useCORS: true
    });
  }

  function downloadImage(src) {
    const link = document.createElement("a");
    link.href = src;
    link.download = "pawspace-roast.png";
    link.click();
  }

  shareBtn.addEventListener("click", async () => {
    const canvas = await generateCanvas();
    canvas.toBlob(async blob => {
      const file = new File([blob], "pawspace-roast.png", { type: "image/png" });

      if (navigator.canShare && navigator.canShare({ files: [file] })) {
        await navigator.share({
          files: [file],
          title: "Roast my pet üòà",
          text: "Roast your pet ‚Üí pawspace.vercel.app"
        });
      } else {
        downloadImage(canvas.toDataURL("image/png", 1.0));
      }
    });
  });

  downloadBtn.addEventListener("click", async () => {
    const canvas = await generateCanvas();
    downloadImage(canvas.toDataURL("image/png", 1.0));
  });

  /* ---------- VIDEO CREATION ---------- */
  videoBtn.addEventListener("click", async () => {
    alert("Creating video‚Ä¶ please wait ‚è≥");

    roastText.style.opacity = 0;

    const stream = card.captureStream(30);
    const recorder = new MediaRecorder(stream, { mimeType: "video/webm" });
    const chunks = [];

    recorder.ondataavailable = e => chunks.push(e.data);
    recorder.start();

    setTimeout(() => roastText.style.opacity = 1, 1500);
    setTimeout(() => recorder.stop(), 7000);

    recorder.onstop = async () => {
      const blob = new Blob(chunks, { type: "video/webm" });
      const file = new File([blob], "pawspace-roast-video.webm", { type: "video/webm" });

      if (navigator.canShare && navigator.canShare({ files: [file] })) {
        await navigator.share({
          files: [file],
          title: "Roast my pet üòà",
          text: "Roast your pet ‚Üí pawspace.vercel.app"
        });
      } else {
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "pawspace-roast-video.webm";
        link.click();
      }
    };
  });
</script>
</body>
</html>
